var webeid=function(e){"use strict";var t;!function(e){e.WARNING="web-eid:warning",e.STATUS="web-eid:status",e.STATUS_ACK="web-eid:status-ack",e.STATUS_SUCCESS="web-eid:status-success",e.STATUS_FAILURE="web-eid:status-failure",e.AUTHENTICATE="web-eid:authenticate",e.AUTHENTICATE_ACK="web-eid:authenticate-ack",e.AUTHENTICATE_SUCCESS="web-eid:authenticate-success",e.AUTHENTICATE_FAILURE="web-eid:authenticate-failure",e.GET_SIGNING_CERTIFICATE="web-eid:get-signing-certificate",e.GET_SIGNING_CERTIFICATE_ACK="web-eid:get-signing-certificate-ack",e.GET_SIGNING_CERTIFICATE_SUCCESS="web-eid:get-signing-certificate-success",e.GET_SIGNING_CERTIFICATE_FAILURE="web-eid:get-signing-certificate-failure",e.SIGN="web-eid:sign",e.SIGN_ACK="web-eid:sign-ack",e.SIGN_SUCCESS="web-eid:sign-success",e.SIGN_FAILURE="web-eid:sign-failure"}(t||(t={}));var E,s=t;!function(e){e.ERR_WEBEID_ACTION_TIMEOUT="ERR_WEBEID_ACTION_TIMEOUT",e.ERR_WEBEID_USER_TIMEOUT="ERR_WEBEID_USER_TIMEOUT",e.ERR_WEBEID_VERSION_MISMATCH="ERR_WEBEID_VERSION_MISMATCH",e.ERR_WEBEID_VERSION_INVALID="ERR_WEBEID_VERSION_INVALID",e.ERR_WEBEID_EXTENSION_UNAVAILABLE="ERR_WEBEID_EXTENSION_UNAVAILABLE",e.ERR_WEBEID_NATIVE_UNAVAILABLE="ERR_WEBEID_NATIVE_UNAVAILABLE",e.ERR_WEBEID_UNKNOWN_ERROR="ERR_WEBEID_UNKNOWN_ERROR",e.ERR_WEBEID_CONTEXT_INSECURE="ERR_WEBEID_CONTEXT_INSECURE",e.ERR_WEBEID_USER_CANCELLED="ERR_WEBEID_USER_CANCELLED",e.ERR_WEBEID_NATIVE_INVALID_ARGUMENT="ERR_WEBEID_NATIVE_INVALID_ARGUMENT",e.ERR_WEBEID_NATIVE_FATAL="ERR_WEBEID_NATIVE_FATAL",e.ERR_WEBEID_ACTION_PENDING="ERR_WEBEID_ACTION_PENDING",e.ERR_WEBEID_MISSING_PARAMETER="ERR_WEBEID_MISSING_PARAMETER"}(E||(E={}));var i=E;class n extends Error{constructor(e){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_MISSING_PARAMETER}}class r extends Error{constructor(e="same action for Web-eID browser extension is already pending"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_ACTION_PENDING}}class a extends Error{constructor(e="extension message timeout"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_ACTION_TIMEOUT}}class o extends Error{constructor(e="Secure context required, see https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_CONTEXT_INSECURE}}class c extends Error{constructor(e="Web-eID extension is not available"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_EXTENSION_UNAVAILABLE}}var _=Object.freeze({VERSION:"2.1.0",EXTENSION_HANDSHAKE_TIMEOUT:1e3,NATIVE_APP_HANDSHAKE_TIMEOUT:5e3,DEFAULT_USER_INTERACTION_TIMEOUT:12e4,MAX_EXTENSION_LOAD_DELAY:1e3});class I extends Error{constructor(e="native application terminated with a fatal error"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_NATIVE_FATAL}}class R extends Error{constructor(e="native application received an invalid argument"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_NATIVE_INVALID_ARGUMENT}}class T extends Error{constructor(e="Web-eID native application is not available"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_NATIVE_UNAVAILABLE}}class A extends Error{constructor(e="an unknown error occurred"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_UNKNOWN_ERROR}}class u extends Error{constructor(e="request was cancelled by the user"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_USER_CANCELLED}}class N extends Error{constructor(e="user failed to respond in time"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_USER_TIMEOUT}}class S extends Error{constructor(e="invalid version string"){super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_VERSION_INVALID}}function d(e,t){return`Update required for Web-eID ${t}`}class h extends Error{constructor(e,t,E){if(e||(E?E.extension&&E.nativeApp?e=d`${"extension and native app"}`:E.extension?e=d`${"extension"}`:E.nativeApp&&(e=d`${"native app"}`):e="requiresUpdate not provided"),super(e),this.name=this.constructor.name,this.code=i.ERR_WEBEID_VERSION_MISMATCH,this.requiresUpdate=E??{nativeApp:!1,extension:!1},t){const{library:e,extension:E,nativeApp:s}=t;Object.assign(this,{library:e,extension:E,nativeApp:s})}}}const D={[i.ERR_WEBEID_ACTION_PENDING]:r,[i.ERR_WEBEID_ACTION_TIMEOUT]:a,[i.ERR_WEBEID_CONTEXT_INSECURE]:o,[i.ERR_WEBEID_EXTENSION_UNAVAILABLE]:c,[i.ERR_WEBEID_MISSING_PARAMETER]:n,[i.ERR_WEBEID_NATIVE_INVALID_ARGUMENT]:R,[i.ERR_WEBEID_NATIVE_FATAL]:I,[i.ERR_WEBEID_NATIVE_UNAVAILABLE]:T,[i.ERR_WEBEID_USER_CANCELLED]:u,[i.ERR_WEBEID_USER_TIMEOUT]:N,[i.ERR_WEBEID_VERSION_INVALID]:S,[i.ERR_WEBEID_VERSION_MISMATCH]:h,[i.ERR_WEBEID_UNKNOWN_ERROR]:A};function m(e){let t;if(function(e){if("object"!=typeof e||null===e)return!1;const t=e;return"string"==typeof t.code&&"string"==typeof t.message&&null!=D[t.code]}(e)){const E=D[e.code];t=new E,Object.entries(e).forEach((([e,E])=>{Reflect.set(t,e,E)}))}else{t=new A;const E=e;E?.stack&&(t.stack=E.stack),E?.message&&(t.message=E.message)}return t}const l=new class{constructor(){this.loggedWarnings=[],this.queue=[],window.addEventListener("message",(e=>this.receive(e)))}receive(e){if(!e.data?.action?.startsWith("web-eid:"))return;const t=e.data,E=["success","failure","ack"].find((e=>t.action.endsWith(e))),i=this.getInitialAction(t.action),n=this.getPendingMessage(i);if(t.action===s.WARNING)t.warnings?.forEach((e=>{this.loggedWarnings.includes(e)||(this.loggedWarnings.push(e),console.warn(e.replace(/\n|\r/g,"")))}));else if(n)switch(E){case"ack":clearTimeout(n.ackTimer);break;case"success":this.removeFromQueue(i),n.resolve?.(t);break;case"failure":{const e=t;this.removeFromQueue(i),n.reject?.(m(e.error));break}}}send(e,t){if(this.getPendingMessage(e.action))return Promise.reject(new r);if(window.isSecureContext){const E={message:e};return this.queue.push(E),E.promise=new Promise(((e,t)=>{E.resolve=e,E.reject=t})),E.ackTimer=window.setTimeout((()=>this.onAckTimeout(E)),_.EXTENSION_HANDSHAKE_TIMEOUT),E.replyTimer=window.setTimeout((()=>this.onReplyTimeout(E)),t),window.postMessage(e,"*"),E.promise}return Promise.reject(new o)}onReplyTimeout(e){this.removeFromQueue(e.message.action),e.reject?.(new a)}onAckTimeout(e){clearTimeout(e.replyTimer),this.removeFromQueue(e.message.action),e.reject?.(new c)}getPendingMessage(e){return this.queue.find((t=>t.message.action===e))}getInitialAction(e){return e.replace(/-success$|-failure$|-ack$/,"")}removeFromQueue(e){const t=this.getPendingMessage(e);clearTimeout(t?.replyTimer),this.queue=this.queue.filter((t=>t.message.action!==e))}},g=+new Date;async function U(){const e=+new Date;var t;await(t=g+_.MAX_EXTENSION_LOAD_DELAY-e,new Promise((e=>{setTimeout((()=>e()),t)})))}return e.Action=s,e.ErrorCode=i,e.authenticate=async function(e,t){if(await U(),!e)throw new n("authenticate function requires a challengeNonce");const E=_.EXTENSION_HANDSHAKE_TIMEOUT+_.NATIVE_APP_HANDSHAKE_TIMEOUT+(t?.userInteractionTimeout??_.DEFAULT_USER_INTERACTION_TIMEOUT),i={action:s.AUTHENTICATE,libraryVersion:_.VERSION,challengeNonce:e,options:t},{unverifiedCertificate:r,algorithm:a,signature:o,format:c,appVersion:I}=await l.send(i,E);return{unverifiedCertificate:r,algorithm:a,signature:o,format:c,appVersion:I}},e.config=_,e.getSigningCertificate=async function(e){await U();const t=_.EXTENSION_HANDSHAKE_TIMEOUT+_.NATIVE_APP_HANDSHAKE_TIMEOUT+2*(e?.userInteractionTimeout??_.DEFAULT_USER_INTERACTION_TIMEOUT),E={action:s.GET_SIGNING_CERTIFICATE,libraryVersion:_.VERSION,options:e},{certificate:i,supportedSignatureAlgorithms:n}=await l.send(E,t);return{certificate:i,supportedSignatureAlgorithms:n}},e.sign=async function(e,t,E,i){if(await U(),!e)throw new n("sign function requires a certificate as parameter");if(!t)throw new n("sign function requires a hash as parameter");if(!E)throw new n("sign function requires a hashFunction as parameter");const r=_.EXTENSION_HANDSHAKE_TIMEOUT+_.NATIVE_APP_HANDSHAKE_TIMEOUT+2*(i?.userInteractionTimeout??_.DEFAULT_USER_INTERACTION_TIMEOUT),a={action:s.SIGN,libraryVersion:_.VERSION,certificate:e,hash:t,hashFunction:E,options:i},{signature:o,signatureAlgorithm:c}=await l.send(a,r);return{signature:o,signatureAlgorithm:c}},e.status=async function(){await U();const e=_.EXTENSION_HANDSHAKE_TIMEOUT+_.NATIVE_APP_HANDSHAKE_TIMEOUT,t={action:s.STATUS,libraryVersion:_.VERSION};try{const{library:E,extension:s,nativeApp:i}=await l.send(t,e);return{library:E,extension:s,nativeApp:i}}catch(e){throw e instanceof Error&&Reflect.set(e,"library",_.VERSION),e}},e}({});
